<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.21">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kanoa Parker">
<meta name="description" content="Programming a STM32L432KC Microcontroller to read temperature from a DS1722 and Display readings on a ESP8266 Webserver.">

<title>Lab 6 ‚Äì E155 Portfolio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-ea1d7ac60288e0f1efdbc993fd8432ae.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e31584831b205ffbb2d98406f31c2a5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">E155 Portfolio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../labss.html"> 
<span class="menu-text">LABS</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resources.html"> 
<span class="menu-text">resources</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#table-of-contents" id="toc-table-of-contents" class="nav-link active" data-scroll-target="#table-of-contents">Table of Contents</a></li>
  <li><a href="#this-it-the-introduction" id="toc-this-it-the-introduction" class="nav-link" data-scroll-target="#this-it-the-introduction">This it the Introduction </a><a name="introdction" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#schematic" id="toc-schematic" class="nav-link" data-scroll-target="#schematic">Schematic </a><a name="Schematic" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#c-code" id="toc-c-code" class="nav-link" data-scroll-target="#c-code">C Code </a><a name="c_code" class="nav-link" data-scroll-target="undefined"></a>
  <ul class="collapse">
  <li><a href="#main-c" id="toc-main-c" class="nav-link" data-scroll-target="#main-c">Main C </a><a name="main" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#main-header" id="toc-main-header" class="nav-link" data-scroll-target="#main-header">Main Header </a><a name="mainh" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#startup" id="toc-startup" class="nav-link" data-scroll-target="#startup">startup() </a><a name="start" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#updatesensitivity" id="toc-updatesensitivity" class="nav-link" data-scroll-target="#updatesensitivity">updateSensitivity </a><a name="updsens" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#updateledstatus" id="toc-updateledstatus" class="nav-link" data-scroll-target="#updateledstatus">updateLEDStatus</a><a name="updled" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#instring" id="toc-instring" class="nav-link" data-scroll-target="#instring">inString</a><a name="inString" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#html-webpage-setup" id="toc-html-webpage-setup" class="nav-link" data-scroll-target="#html-webpage-setup">HTML Webpage Setup </a><a name="html" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#spi-header" id="toc-spi-header" class="nav-link" data-scroll-target="#spi-header">SPI Header </a><a name="spih" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#spi-c-file" id="toc-spi-c-file" class="nav-link" data-scroll-target="#spi-c-file">SPI C File </a><a name="spic" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#ds1722-header" id="toc-ds1722-header" class="nav-link" data-scroll-target="#ds1722-header">DS1722 Header </a><a name="dsh" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#ds1722-c" id="toc-ds1722-c" class="nav-link" data-scroll-target="#ds1722-c">DS1722 C </a><a name="dsc" class="nav-link" data-scroll-target="undefined"></a></li>
  </ul></li>
  <li><a href="#oscilliscope-capture-of-sample-spi-communication-between-ds1722-and-mcu" id="toc-oscilliscope-capture-of-sample-spi-communication-between-ds1722-and-mcu" class="nav-link" data-scroll-target="#oscilliscope-capture-of-sample-spi-communication-between-ds1722-and-mcu">Oscilliscope Capture of Sample SPI communication between DS1722 and MCU </a><a name="samp_spi" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#ai-prototype" id="toc-ai-prototype" class="nav-link" data-scroll-target="#ai-prototype">AI Prototype </a><a name="aip" class="nav-link" data-scroll-target="undefined"></a>
  <ul class="collapse">
  <li><a href="#respone-from-chatgpt-html-code-and-rendered-code" id="toc-respone-from-chatgpt-html-code-and-rendered-code" class="nav-link" data-scroll-target="#respone-from-chatgpt-html-code-and-rendered-code">Respone from Chatgpt HTML Code and rendered code</a></li>
  <li><a href="#temperature-c-code" id="toc-temperature-c-code" class="nav-link" data-scroll-target="#temperature-c-code">Temperature C Code</a>
  <ul class="collapse">
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">üß† Background</a></li>
  <li><a href="#example-function" id="toc-example-function" class="nav-link" data-scroll-target="#example-function">‚úÖ Example Function</a></li>
  <li><a href="#setup-notes" id="toc-setup-notes" class="nav-link" data-scroll-target="#setup-notes">‚öôÔ∏è Setup Notes</a></li>
  <li><a href="#optional-enhancements" id="toc-optional-enhancements" class="nav-link" data-scroll-target="#optional-enhancements">üß© Optional Enhancements</a></li>
  </ul></li>
  <li><a href="#reflection" id="toc-reflection" class="nav-link" data-scroll-target="#reflection">Reflection</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lab 6</h1>
</div>

<div>
  <div class="description">
    Programming a STM32L432KC Microcontroller to read temperature from a DS1722 and Display readings on a ESP8266 Webserver.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Kanoa Parker </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 4, 205</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="table-of-contents" class="level1">
<h1>Table of Contents</h1>
<ol type="1">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#Schematic">Schematic</a></li>
<li><a href="#c_code">C Code</a> 3.1 <a href="#main">Main C</a> 3.2 <a href="#mainh">Main Header</a> 3.3 <a href="#start">Start Up Code</a> 3.4 <a href="#updsens">Update Sensitivity</a> 3.5 <a href="#updled">Update LED</a> 3.6 <a href="#inString">In String</a> 3.7 <a href="#html">Webserver set up</a> 3.8 <a href="#spih">SPI Header</a> 3.9 <a href="#spic">SPI C</a> 3.10 <a href="#dsh">DS1722 Header</a> 3.11 <a href="#dsc">DS1722 C</a></li>
<li><a href="#samp_spi">Sample Spi Communication</a></li>
<li><a href="#aip">AI Prototype</a></li>
</ol>
</section>
<section id="this-it-the-introduction" class="level1">
<h1>This it the Introduction <a name="introdction"></a></h1>
<p>In this lab I developed code for the STM32L432KC to communicate to a DS1722 temperature sensor through SPI communication protocals. I then through USART and HTML created a Webpage to display the temperature readings and hosted that webpage on an ESP8266 webserver. The Webserver displays the temperature in degrees Celsius and the number of bits of resolution. In addition there is a button on the Webserver to turn on and off an LED on the Microcontroller. The Lab Meets all specifications and took 9.5 hours to complete.</p>
</section>
<section id="schematic" class="level1">
<h1>Schematic <a name="Schematic"></a></h1>
<p><img src="images\lab6schematic.jpg" class="img-fluid" alt="Schematic of Bread Board"> This a schematic showing connections between the MCU, DS1722, and ESP8266</p>
</section>
<section id="c-code" class="level1">
<h1>C Code <a name="c_code"></a></h1>
<p>This section contains code for the main module and interupt handlers and setup.</p>
<section id="main-c" class="level2">
<h2 class="anchored" data-anchor-id="main-c">Main C <a name="main"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">    File: main.c</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Author: kanoa Parker</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Email: kanoa.parker@hmc.edu</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Date: 11/4/2025</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Description: Code for STM32L432KC to read temperature data from DS1722 and display temperature on Webpage</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  startup<span class="op">();</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  USART_TypeDef <span class="op">*</span> USART <span class="op">=</span> initUSART<span class="op">(</span>USART1_ID<span class="op">,</span> <span class="dv">125000</span><span class="op">);</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">volatile</span> <span class="dt">uint8_t</span> sensitivity<span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">volatile</span> <span class="dt">float</span> temperature<span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">volatile</span> <span class="dt">char</span> tempstring<span class="op">[</span><span class="dv">50</span><span class="op">];</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">volatile</span> <span class="dt">int</span> led_status<span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> ledStatusStr<span class="op">[</span><span class="dv">20</span><span class="op">];</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> sensitivitystatus<span class="op">[</span><span class="dv">20</span><span class="op">];</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  set_sensitivity<span class="op">(</span><span class="bn">0xe0</span><span class="op">);</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Wait for ESP8266 to send a request.</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Requests take the form of '/REQ:&lt;tag&gt;\n', with TAG begin &lt;= 10 characters.</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Therefore the request[] array must be able to contain 18 characters.</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Receive web request from the ESP</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> request<span class="op">[</span>BUFF_LEN<span class="op">]</span> <span class="op">=</span> <span class="st">"                  "</span><span class="op">;</span> <span class="co">// initialize to known value</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> charIndex <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep going until you get end of line character</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(</span>inString<span class="op">(</span>request<span class="op">,</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Wait for a complete request to be transmitted before processing</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span><span class="op">(!(</span>USART<span class="op">-&gt;</span>ISR <span class="op">&amp;</span> USART_ISR_RXNE<span class="op">));</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>      request<span class="op">[</span>charIndex<span class="op">++]</span> <span class="op">=</span> readChar<span class="op">(</span>USART<span class="op">);</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">//read temp</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    temperature <span class="op">=</span> retrieve_temp<span class="op">();</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">//turns float to string</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    sprintf<span class="op">(</span>tempstring<span class="op">,</span> <span class="st">"</span><span class="sc">%f</span><span class="st">"</span><span class="op">,</span>temperature<span class="op">);</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update string with current LED state</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    led_status <span class="op">=</span> updateLEDStatus<span class="op">(</span>request<span class="op">,</span> led_status<span class="op">);</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>led_status <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>      sprintf<span class="op">(</span>ledStatusStr<span class="op">,</span><span class="st">"LED is on!"</span><span class="op">);</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>led_status <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>      sprintf<span class="op">(</span>ledStatusStr<span class="op">,</span><span class="st">"LED is off!"</span><span class="op">);</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    sensitivity <span class="op">=</span> updateSensitivity<span class="op">(</span>request<span class="op">,</span> sensitivity<span class="op">);</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    set_sensitivity<span class="op">(</span>sensitivity<span class="op">);</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>sensitivity <span class="op">==</span> <span class="bn">0xe0</span><span class="op">)</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>      sprintf<span class="op">(</span>sensitivitystatus<span class="op">,</span><span class="st">"8 bits"</span><span class="op">);</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span><span class="op">(</span>sensitivity <span class="op">==</span> <span class="bn">0xe2</span><span class="op">)</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>      sprintf<span class="op">(</span>sensitivitystatus<span class="op">,</span><span class="st">"9 bits"</span><span class="op">);</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span><span class="op">(</span>sensitivity <span class="op">==</span> <span class="bn">0xe4</span><span class="op">)</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>      sprintf<span class="op">(</span>sensitivitystatus<span class="op">,</span><span class="st">"10 bits"</span><span class="op">);</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span><span class="op">(</span>sensitivity <span class="op">==</span> <span class="bn">0xe6</span><span class="op">)</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>      sprintf<span class="op">(</span>sensitivitystatus<span class="op">,</span><span class="st">"11 bits"</span><span class="op">);</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span><span class="op">(</span>sensitivity <span class="op">==</span> <span class="bn">0xe8</span><span class="op">)</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>      sprintf<span class="op">(</span>sensitivitystatus<span class="op">,</span><span class="st">"12 bits"</span><span class="op">);</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">// finally, transmit the webpage over UART</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> webpageStart<span class="op">);</span> <span class="co">// webpage header code</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> ledStr<span class="op">);</span> <span class="co">// button for controlling LED</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> <span class="st">"&lt;h2&gt;LED Status&lt;/h2&gt;"</span><span class="op">);</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> <span class="st">"&lt;p&gt;"</span><span class="op">);</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> ledStatusStr<span class="op">);</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> <span class="st">"&lt;/p&gt;"</span><span class="op">);</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span>tempStr<span class="op">);</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> <span class="st">"&lt;p&gt;"</span><span class="op">);</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> tempstring<span class="op">);</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> <span class="st">"Celsius &lt;/p&gt;"</span><span class="op">);</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> tempsensitivity<span class="op">);</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> <span class="st">"&lt;p&gt; Current sensitivity:"</span><span class="op">);</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> sensitivitystatus<span class="op">);</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> <span class="st">"&lt;/p&gt;"</span><span class="op">);</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    sendString<span class="op">(</span>USART<span class="op">,</span> webpageEnd<span class="op">);</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Main Module.<br>
Link to github with full list of library and header files. <a href="https://github.com/kanparker/e155_lab5">Link to Git Hub</a>.</p>
</section>
<section id="main-header" class="level2">
<h2 class="anchored" data-anchor-id="main-header">Main Header <a name="mainh"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">    Main Header: Contains general defines and selected portions of CMSIS files</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">    </span><span class="an">@file</span><span class="co"> </span><span class="cv">main.h</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span><span class="an">@author</span><span class="co"> Kanoa parker</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span><span class="an">@email</span><span class="co"> kanparker</span><span class="an">@hmc.edu</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span><span class="an">@date</span><span class="co"> 11/4/2025</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef MAIN_H</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAIN_H</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"C:\Users\kanoa\Documents\hmc-e155\lab\lab06\lib\STM32L432KC.h"</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#define LED_PIN PA8 </span><span class="co">// LED pin for blinking on Port B pin 3</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#define LED_PIN2 PA9</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#define BUFF_LEN </span><span class="dv">32</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif </span><span class="co">// MAIN_H</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="startup" class="level2">
<h2 class="anchored" data-anchor-id="startup">startup() <a name="start"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> startup<span class="op">(</span><span class="dt">void</span><span class="op">){</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">///startup code doing configurations</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  configureFlash<span class="op">();</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  configureClock<span class="op">();</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  gpioEnable<span class="op">(</span>GPIO_PORT_A<span class="op">);</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  gpioEnable<span class="op">(</span>GPIO_PORT_B<span class="op">);</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  gpioEnable<span class="op">(</span>GPIO_PORT_C<span class="op">);</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  pinMode<span class="op">(</span>LED_PIN<span class="op">,</span> GPIO_OUTPUT<span class="op">);</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  RCC<span class="op">-&gt;</span>APB2ENR <span class="op">|=</span> <span class="op">(</span>RCC_APB2ENR_TIM15EN<span class="op">);</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  initTIM<span class="op">(</span>TIM15<span class="op">);</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  initSPI<span class="op">(</span><span class="bn">0b101</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="co">// SPI clk = master clk / 64, CPOL = 1, CPHA = 1</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Interupt handler for EXTI0 which is connected to the encoder signal A.</p>
</section>
<section id="updatesensitivity" class="level2">
<h2 class="anchored" data-anchor-id="updatesensitivity">updateSensitivity <a name="updsens"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> updateSensitivity<span class="op">(</span><span class="dt">char</span> request<span class="op">[],</span><span class="dt">uint8_t</span> current_sen<span class="op">)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>       <span class="co">///update sensitivity bits to be sent to DS1722 based on request from webserver</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> sensitivity_status <span class="op">=</span> current_sen<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>inString<span class="op">(</span>request<span class="op">,</span> <span class="st">"8b"</span><span class="op">)==</span><span class="dv">1</span><span class="op">){</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>          sensitivity_status<span class="op">=</span> <span class="bn">0xe0</span><span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>          <span class="co">//blinky();</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>inString<span class="op">(</span>request<span class="op">,</span> <span class="st">"9b"</span><span class="op">)==</span><span class="dv">1</span><span class="op">){</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>          sensitivity_status <span class="op">=</span> <span class="bn">0xe2</span><span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>          <span class="co">//blinky();</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>inString<span class="op">(</span>request<span class="op">,</span> <span class="st">"10b"</span><span class="op">)==</span><span class="dv">1</span><span class="op">){</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>          sensitivity_status <span class="op">=</span> <span class="bn">0xe4</span><span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>          <span class="co">//blinky();</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>inString<span class="op">(</span>request<span class="op">,</span> <span class="st">"11b"</span><span class="op">)==</span><span class="dv">1</span><span class="op">){</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>          sensitivity_status <span class="op">=</span> <span class="bn">0xe6</span><span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>          <span class="co">//blinky();</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>inString<span class="op">(</span>request<span class="op">,</span> <span class="st">"12b"</span><span class="op">)==</span><span class="dv">1</span><span class="op">){</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>          sensitivity_status <span class="op">=</span> <span class="bn">0xe8</span><span class="op">;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>          <span class="co">//blinky();</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sensitivity_status<span class="op">;</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Interupt handler for EXTI0 which is connected to the encoder signal A.</p>
</section>
<section id="updateledstatus" class="level2">
<h2 class="anchored" data-anchor-id="updateledstatus">updateLEDStatus<a name="updled"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> updateLEDStatus<span class="op">(</span><span class="dt">char</span> request<span class="op">[],</span> <span class="dt">int</span> current_status<span class="op">)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>   <span class="co">///updates led status based on webserver request</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> led_status <span class="op">=</span> current_status<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The request has been received. now process to determine whether to turn the LED on or off</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>inString<span class="op">(</span>request<span class="op">,</span> <span class="st">"ledoff"</span><span class="op">)==</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        digitalWrite<span class="op">(</span>LED_PIN<span class="op">,</span> GPIO_LOW<span class="op">);</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        led_status <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>inString<span class="op">(</span>request<span class="op">,</span> <span class="st">"ledon"</span><span class="op">)==</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        digitalWrite<span class="op">(</span>LED_PIN<span class="op">,</span> GPIO_HIGH<span class="op">);</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        led_status <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> led_status<span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="instring" class="level2">
<h2 class="anchored" data-anchor-id="instring">inString<a name="inString"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> inString<span class="op">(</span><span class="dt">char</span> request<span class="op">[],</span> <span class="dt">char</span> des<span class="op">[])</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">///checks for if char is in request</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>strstr<span class="op">(</span>request<span class="op">,</span> des<span class="op">)</span> <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span><span class="cf">return</span> <span class="dv">1</span><span class="op">;}</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="html-webpage-setup" class="level2">
<h2 class="anchored" data-anchor-id="html-webpage-setup">HTML Webpage Setup <a name="html"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">//Defining the web page in two chunks: everything before the current time, and everything after the current time</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span><span class="op">*</span> webpageStart <span class="op">=</span> <span class="st">"&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;E155 Web Server Demo Webpage&lt;/title&gt;</span><span class="op">\</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;meta name=</span><span class="sc">\"</span><span class="st">viewport</span><span class="sc">\"</span><span class="st"> content=</span><span class="sc">\"</span><span class="st">width=device-width, initial-scale=1.0</span><span class="sc">\"</span><span class="st">&gt;</span><span class="op">\</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/head&gt;</span><span class="op">\</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;body&gt;&lt;h1&gt;E155 Web Server Demo Webpage&lt;/h1&gt;"</span><span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span><span class="op">*</span> ledStr <span class="op">=</span> <span class="st">"&lt;p&gt;LED Control:&lt;/p&gt;&lt;form action=</span><span class="sc">\"</span><span class="st">ledon</span><span class="sc">\"</span><span class="st">&gt;&lt;input type=</span><span class="sc">\"</span><span class="st">submit</span><span class="sc">\"</span><span class="st"> value=</span><span class="sc">\"</span><span class="st">Turn the LED on!</span><span class="sc">\"</span><span class="st">&gt;&lt;/form&gt;</span><span class="op">\</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;form action=</span><span class="sc">\"</span><span class="st">ledoff</span><span class="sc">\"</span><span class="st">&gt;&lt;input type=</span><span class="sc">\"</span><span class="st">submit</span><span class="sc">\"</span><span class="st"> value=</span><span class="sc">\"</span><span class="st">Turn the LED off!</span><span class="sc">\"</span><span class="st">&gt;&lt;/form&gt;"</span><span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">//Defining Temperature Reading</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span><span class="op">*</span> tempStr <span class="op">=</span> <span class="st">"&lt;h2&gt; Temperature Sensor Reading:&lt;/h2&gt;"</span><span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">//Form for temperature sensitivity</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span><span class="op">*</span> tempsensitivity <span class="op">=</span> <span class="st">"&lt;p&gt;Temperature Sensitivity Control&lt;/p&gt;&lt;form action= </span><span class="sc">\"</span><span class="st">sensitivity</span><span class="sc">\"</span><span class="st">&gt;</span><span class="op">\</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;input type=</span><span class="sc">\"</span><span class="st">radio</span><span class="sc">\"</span><span class="st"> id=</span><span class="sc">\"</span><span class="st">8 bit</span><span class="sc">\"</span><span class="st"> name=</span><span class="sc">\"</span><span class="st">fav</span><span class="sc">\"</span><span class="st"> value=</span><span class="sc">\"</span><span class="st">8b</span><span class="sc">\"</span><span class="st">&gt;</span><span class="op">\</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;label for=</span><span class="sc">\"</span><span class="st">8 bit</span><span class="sc">\"</span><span class="st">&gt;8 bit&lt;/label&gt;&lt;br&gt;</span><span class="op">\</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;input type=</span><span class="sc">\"</span><span class="st">radio</span><span class="sc">\"</span><span class="st"> id=</span><span class="sc">\"</span><span class="st">9 bit</span><span class="sc">\"</span><span class="st"> name=</span><span class="sc">\"</span><span class="st">fav</span><span class="sc">\"</span><span class="st"> value=</span><span class="sc">\"</span><span class="st">9b</span><span class="sc">\"</span><span class="st">&gt;</span><span class="op">\</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;label for=</span><span class="sc">\"</span><span class="st">9 bit</span><span class="sc">\"</span><span class="st">&gt;9 bit&lt;/label&gt;&lt;br&gt;</span><span class="op">\</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;input type=</span><span class="sc">\"</span><span class="st">radio</span><span class="sc">\"</span><span class="st"> id=</span><span class="sc">\"</span><span class="st">10 bit</span><span class="sc">\"</span><span class="st"> name=</span><span class="sc">\"</span><span class="st">fav</span><span class="sc">\"</span><span class="st"> value=</span><span class="sc">\"</span><span class="st">10b</span><span class="sc">\"</span><span class="st">&gt;</span><span class="op">\</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;label for=</span><span class="sc">\"</span><span class="st">10 bit</span><span class="sc">\"</span><span class="st">&gt;10 bit&lt;/label&gt;&lt;br&gt;</span><span class="op">\</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;input type=</span><span class="sc">\"</span><span class="st">radio</span><span class="sc">\"</span><span class="st"> id=</span><span class="sc">\"</span><span class="st">11 bit</span><span class="sc">\"</span><span class="st"> name=</span><span class="sc">\"</span><span class="st">fav</span><span class="sc">\"</span><span class="st"> value=</span><span class="sc">\"</span><span class="st">11b</span><span class="sc">\"</span><span class="st">&gt;</span><span class="op">\</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;label for=</span><span class="sc">\"</span><span class="st">11 bit</span><span class="sc">\"</span><span class="st">&gt;11 bit&lt;/label&gt;&lt;br&gt;</span><span class="op">\</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;input type=</span><span class="sc">\"</span><span class="st">radio</span><span class="sc">\"</span><span class="st"> id=</span><span class="sc">\"</span><span class="st">12 bit</span><span class="sc">\"</span><span class="st"> name=</span><span class="sc">\"</span><span class="st">fav</span><span class="sc">\"</span><span class="st"> value=</span><span class="sc">\"</span><span class="st">12b</span><span class="sc">\"</span><span class="st">&gt;</span><span class="op">\</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;label for=</span><span class="sc">\"</span><span class="st">12 bit</span><span class="sc">\"</span><span class="st">&gt;12 bit&lt;/label&gt;&lt;br&gt;</span><span class="op">\</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;input type=</span><span class="sc">\"</span><span class="st">submit</span><span class="sc">\"</span><span class="st"> value=</span><span class="sc">\"</span><span class="st">Submit</span><span class="sc">\"</span><span class="st">&gt;</span><span class="op">\</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/form&gt;"</span><span class="op">;</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span><span class="op">*</span> webpageEnd   <span class="op">=</span> <span class="st">"&lt;/body&gt;&lt;/html&gt;"</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="spi-header" class="level2">
<h2 class="anchored" data-anchor-id="spi-header">SPI Header <a name="spih"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// STM32L432KC_SPI.h</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: Kanoa Parker</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">//kanparker@hmc.edu</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">// 11/4/2025</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">//SPI header file</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef STM32L4_SPI_H</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define STM32L4_SPI_H</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stm32l432xx.h&gt;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">///////////////////////////////////////////////////////////////////////////////</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Function prototypes</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">///////////////////////////////////////////////////////////////////////////////</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">/* Enables the SPI peripheral and intializes its clock speed (baud rate), polarity, and phase.</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"> *    -- br: (0b000 - 0b111). The SPI clk will be the master clock / 2^(BR+1).</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co"> *    -- cpol: clock polarity (0: inactive state is logical 0, 1: inactive state is logical 1).</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"> *    -- cpha: clock phase (0: data captured on leading edge of clk and changed on next edge, </span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"> *          1: data changed on leading edge of clk and captured on next edge)</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co"> * Refer to the datasheet for more low-level details. */</span> </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> initSPI<span class="op">(</span><span class="dt">int</span> br<span class="op">,</span> <span class="dt">int</span> cpol<span class="op">,</span> <span class="dt">int</span> cpha<span class="op">);</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co">/* Transmits a character (1 byte) over SPI and returns the received character.</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co"> *    -- send: the character to send over SPI</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co"> *    -- return: the character received over SPI */</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> spiSendReceive<span class="op">(</span><span class="dt">char</span> send<span class="op">);</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="spi-c-file" class="level2">
<h2 class="anchored" data-anchor-id="spi-c-file">SPI C File <a name="spic"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// STM32L432KC_SPI.c</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: Kanoa Parker</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: kanparker@hmc.edu</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: 11/4/2025</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: SPI C files to send and recieve data</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"STM32L432KC.h"</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"STM32L432KC_SPI.h"</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"STM32L432KC_RCC.h"</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"STM32L432KC_GPIO.h"</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> initSPI<span class="op">(</span><span class="dt">int</span> br<span class="op">,</span> <span class="dt">int</span> cpol<span class="op">,</span> <span class="dt">int</span> cpha<span class="op">){</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Enable SPI1 clock</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    RCC<span class="op">-&gt;</span>APB2ENR <span class="op">|=</span> RCC_APB2ENR_SPI1EN<span class="op">;</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    RCC<span class="op">-&gt;</span>AHB2ENR <span class="op">|=</span> RCC_AHB2ENR_GPIOAEN<span class="op">;</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    RCC<span class="op">-&gt;</span>AHB2ENR <span class="op">|=</span> RCC_AHB2ENR_GPIOBEN<span class="op">;</span> <span class="co">// Enable GPIOA clock for SPI1 pins</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Configure GPIO pins for SPI1</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    pinMode<span class="op">(</span>PB3<span class="op">,</span> GPIO_ALT<span class="op">);</span> <span class="co">// SCK</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    pinMode<span class="op">(</span>PB4<span class="op">,</span> GPIO_ALT<span class="op">);</span> <span class="co">// MISO</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    pinMode<span class="op">(</span>PB5<span class="op">,</span> GPIO_ALT<span class="op">);</span> <span class="co">// MOSI</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    pinMode<span class="op">(</span>PB1<span class="op">,</span> GPIO_OUTPUT<span class="op">);</span> <span class="co">// CE</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">//Set alternate function to AF5 (SPI1)</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    GPIOB<span class="op">-&gt;</span>AFR<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">|=</span> _VAL2FLD<span class="op">(</span>GPIO_AFRL_AFSEL3<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    GPIOB<span class="op">-&gt;</span>AFR<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">|=</span> _VAL2FLD<span class="op">(</span>GPIO_AFRL_AFSEL4<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    GPIOB<span class="op">-&gt;</span>AFR<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">|=</span> _VAL2FLD<span class="op">(</span>GPIO_AFRL_AFSEL5<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    GPIOB <span class="op">-&gt;</span>OSPEEDR <span class="op">|=</span> <span class="op">(</span>GPIO_OSPEEDR_OSPEED3<span class="op">);</span> <span class="co">// Set PA5 speed to high</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Configure SPI1</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    SPI1<span class="op">-&gt;</span>CR1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// Reset CR1 register</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set baud rate, clock polarity, and clock phase</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    SPI1<span class="op">-&gt;</span>CR1 <span class="op">&amp;=</span> <span class="op">~(</span>SPI_CR1_CPOL <span class="op">|</span> SPI_CR1_CPHA <span class="op">|</span> SPI_CR1_LSBFIRST <span class="op">|</span> SPI_CR1_SSM<span class="op">);</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    SPI1<span class="op">-&gt;</span>CR1 <span class="op">|=</span> _VAL2FLD<span class="op">(</span>SPI_CR1_BR<span class="op">,</span> br<span class="op">);</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    SPI1<span class="op">-&gt;</span>CR1 <span class="op">|=</span> _VAL2FLD<span class="op">(</span>SPI_CR1_CPOL<span class="op">,</span> cpol<span class="op">);</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    SPI1<span class="op">-&gt;</span>CR1 <span class="op">|=</span> _VAL2FLD<span class="op">(</span>SPI_CR1_CPHA<span class="op">,</span> cpha<span class="op">);</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set as Master,</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    SPI1<span class="op">-&gt;</span>CR1 <span class="op">|=</span> _VAL2FLD<span class="op">(</span>SPI_CR1_MSTR<span class="op">,</span><span class="dv">1</span><span class="op">);</span> </span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set data frame format to 8 bits</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    SPI1<span class="op">-&gt;</span>CR2 <span class="op">|=</span> _VAL2FLD<span class="op">(</span>SPI_CR2_DS<span class="op">,</span><span class="bn">0b0111</span><span class="op">);</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    SPI1<span class="op">-&gt;</span>CR2 <span class="op">|=</span> <span class="op">(</span>SPI_CR2_FRXTH<span class="op">);</span> <span class="co">// Set RXNE threshold to 8 bits</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    SPI1<span class="op">-&gt;</span>CR2 <span class="op">|=</span> <span class="op">(</span>SPI_CR2_SSOE<span class="op">);</span> <span class="co">// Enable SS output</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Enable SPI</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    SPI1<span class="op">-&gt;</span>CR1 <span class="op">|=</span> SPI_CR1_SPE<span class="op">;</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> spiSendReceive<span class="op">(</span><span class="dt">char</span> send<span class="op">){</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Wait until TXE (Transmit buffer empty) flag is set</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(!(</span>SPI1<span class="op">-&gt;</span>SR <span class="op">&amp;</span> SPI_SR_TXE<span class="op">));</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Send data</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">*(</span><span class="dt">volatile</span> <span class="dt">uint8_t</span> <span class="op">*)</span> <span class="op">(&amp;</span>SPI1<span class="op">-&gt;</span>DR<span class="op">)</span> <span class="op">=</span> send<span class="op">;</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Wait until RXNE (Receive buffer not empty) flag is set</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(!(</span>SPI1<span class="op">-&gt;</span>SR <span class="op">&amp;</span> SPI_SR_RXNE<span class="op">));</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read and return received data</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> readval <span class="op">=</span> <span class="op">(</span><span class="dt">volatile</span> <span class="dt">char</span><span class="op">)</span> SPI1<span class="op">-&gt;</span>DR<span class="op">;</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> readval<span class="op">;</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="ds1722-header" class="level2">
<h2 class="anchored" data-anchor-id="ds1722-header">DS1722 Header <a name="dsh"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// DS1722.h</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: Kanoa Parker</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: kanparker@g.hmc.edu</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: 11/3/2025</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: Modules for setting temperature sensitivity and extracting temperature data from DS1722</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef STM32L4_DS1722_H</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define STM32L4_DS1722_H</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stm32l432xx.h&gt;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"STM32L432KC_GPIO.h"</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> retrieve_temp<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> set_sensitivity<span class="op">(</span><span class="dt">uint8_t</span> sensitivity<span class="op">);</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="ds1722-c" class="level2">
<h2 class="anchored" data-anchor-id="ds1722-c">DS1722 C <a name="dsc"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// DS1722.c</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: Kanoa Parker</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: kanparker@g.hmc.edu</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: 11/3/2025</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: Modules for setting temperature sensitivity and extracting temperature data from DS1722</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"STM32L432KC_GPIO.h"</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"STM32L432KC_SPI.h"</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"DS1722.h"</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> retrieve_temp<span class="op">(</span><span class="dt">void</span><span class="op">){</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">volatile</span> <span class="dt">uint16_t</span> temp_reading<span class="op">;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">volatile</span> <span class="dt">uint8_t</span> temp_reading2<span class="op">;</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">volatile</span> <span class="dt">uint8_t</span> sensitivity<span class="op">;</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">volatile</span> <span class="dt">float</span> temperature<span class="op">;</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">//volatile char tempstring[50];</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    digitalWrite<span class="op">(</span>PB1<span class="op">,</span>GPIO_HIGH<span class="op">);</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    spiSendReceive<span class="op">(</span><span class="bn">0x02</span><span class="op">);</span> <span class="co">//First half of bits address</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    temp_reading <span class="op">=</span> spiSendReceive<span class="op">(</span><span class="bn">0x50</span><span class="op">);</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    digitalWrite<span class="op">(</span>PB1<span class="op">,</span>GPIO_LOW<span class="op">);</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">//printf("First Half of Bits is %d\n",temp_reading);</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    digitalWrite<span class="op">(</span>PB1<span class="op">,</span>GPIO_HIGH<span class="op">);</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    spiSendReceive<span class="op">(</span><span class="bn">0x01</span><span class="op">);</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    temp_reading2 <span class="op">=</span> spiSendReceive<span class="op">(</span><span class="bn">0x50</span><span class="op">);</span> <span class="co">//Second half of bits</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    digitalWrite<span class="op">(</span>PB1<span class="op">,</span>GPIO_LOW<span class="op">);</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">//printf("Second half of bits %d\n",temp_reading2);</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    temp_reading <span class="op">=</span> <span class="op">((</span><span class="dt">uint16_t</span><span class="op">)(</span>temp_reading<span class="op">)&lt;&lt;</span><span class="dv">8</span> <span class="op">|</span> temp_reading2<span class="op">);</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    temp_reading <span class="op">=</span> <span class="op">(</span><span class="dt">float</span><span class="op">)(</span>temp_reading<span class="op">);</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    temperature <span class="op">=</span> temp_reading<span class="op">/</span><span class="fl">256.0</span><span class="op">;</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">//printf("The temperature is: %f\n",temperature);</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">//sprintf(tempstring, "%f",temperature);</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> temperature<span class="op">;</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> set_sensitivity<span class="op">(</span><span class="dt">uint8_t</span> sensitivity<span class="op">){</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    digitalWrite<span class="op">(</span>PB1<span class="op">,</span>GPIO_HIGH<span class="op">);</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    spiSendReceive<span class="op">(</span><span class="bn">0x80</span><span class="op">);</span>  </span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    spiSendReceive<span class="op">(</span>sensitivity<span class="op">);</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    digitalWrite<span class="op">(</span>PB1<span class="op">,</span>GPIO_LOW<span class="op">);</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="oscilliscope-capture-of-sample-spi-communication-between-ds1722-and-mcu" class="level1">
<h1>Oscilliscope Capture of Sample SPI communication between DS1722 and MCU <a name="samp_spi"></a></h1>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images\NewFi.png" class="img-fluid figure-img"></p>
<figcaption>Schematic of Bread Board</figcaption>
</figure>
</div>
</section>
<section id="ai-prototype" class="level1">
<h1>AI Prototype <a name="aip"></a></h1>
<section id="respone-from-chatgpt-html-code-and-rendered-code" class="level2">
<h2 class="anchored" data-anchor-id="respone-from-chatgpt-html-code-and-rendered-code">Respone from Chatgpt HTML Code and rendered code</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images\chattempweb.png" class="img-fluid figure-img"></p>
<figcaption>Rendered Website</figcaption>
</figure>
</div>
<p>Done ‚Äî I created a single-file HTML page titled temperature-portal.html in the canvas (you can open it on the right).</p>
<p>What‚Äôs included</p>
<p>Clean, responsive UI with modern dark theme and accessible controls.</p>
<p>Big live temperature readout (with unit) and a small sparkline showing recent history.</p>
<p>Precision selector (0‚Äì3 decimals).</p>
<p>LED control with animated indicator and buttons (sends via WebSocket if connected, falls back to POST /api/led).</p>
<p>WebSocket connection input (editable) and Connect / Disconnect buttons.</p>
<p>Demo mode to simulate sensor data if you don‚Äôt have a backend.</p>
<p>Basic logs panel and keyboard shortcut (Space toggles demo).</p>
<p>How to hook it up</p>
<p>Edit the WebSocket URL in the ‚ÄúConnection‚Äù field (default ws://localhost:8080) and click Apply URL then Connect. WebSocket messages should be JSON like:</p>
<p>{ ‚ÄúsensorId‚Äù: ‚Äúyour-id‚Äù, ‚Äútemp‚Äù: 23.12, ‚Äúunit‚Äù: ‚Äú¬∞C‚Äù }</p>
<p>If you prefer HTTP polling, implement GET /api/temperature that returns { ‚Äútemp‚Äù: 23.12, ‚Äúunit‚Äù: ‚Äú¬∞C‚Äù }. The page polls that endpoint every ~1.5s when not using WebSocket.</p>
<p>LED: WebSocket will receive { ‚Äúled‚Äù: true } when user toggles; otherwise the page attempts POST /api/led with {‚Äúled‚Äù: true}.</p>
<p>If you want, I can:</p>
<p>Convert this into a React component/page (single-file) with Tailwind.</p>
<p>Add authentication headers or an API-key flow.</p>
<p>Wire up MQTT instead of WebSocket, or adapt payload formats.</p>
<p>Tell me which of those (or anything else) you want next and I‚Äôll update the file directly.</p>
</section>
<section id="temperature-c-code" class="level2">
<h2 class="anchored" data-anchor-id="temperature-c-code">Temperature C Code</h2>
<p>Here‚Äôs a clean and robust example of a C function that uses <strong>CMSIS</strong> (and STM32 HAL-style register access) to perform a <strong>SPI transaction</strong> and retrieve the <strong>temperature reading</strong> from a <strong>DS1722</strong> digital thermometer on an <strong>STM32L432KC</strong>.</p>
<hr>
<section id="background" class="level3">
<h3 class="anchored" data-anchor-id="background">üß† Background</h3>
<ul>
<li>The <strong>DS1722</strong> uses an SPI interface (Mode 3: <code>CPOL=1</code>, <code>CPHA=1</code>).</li>
<li>To read temperature, you issue a <em>Read Temperature MSB</em> command (<code>0x02</code>) and optionally the <em>Read LSB</em> command (<code>0x01</code>) after it, depending on resolution.</li>
<li>Each register read is one byte, MSB first.</li>
<li>The temperature register is <strong>16-bit</strong>, left-justified.</li>
</ul>
<hr>
</section>
<section id="example-function" class="level3">
<h3 class="anchored" data-anchor-id="example-function">‚úÖ Example Function</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"stm32l4xx.h"</span><span class="pp">  </span><span class="co">// CMSIS header for STM32L4 series</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">// DS1722 Register addresses</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define DS1722_REG_TEMP_MSB  </span><span class="bn">0x02</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define DS1722_REG_TEMP_LSB  </span><span class="bn">0x01</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">// SPI chip select macros</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#define DS1722_CS_LOW</span><span class="op">()</span><span class="pp">   </span><span class="op">(</span><span class="pp">GPIOA</span><span class="op">-&gt;</span><span class="pp">BSRR </span><span class="op">=</span><span class="pp"> </span><span class="op">(</span><span class="dt">uint32_t</span><span class="op">)(</span><span class="dv">1</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span><span class="op">(</span><span class="dv">4</span><span class="pp"> </span><span class="op">+</span><span class="pp"> </span><span class="dv">16</span><span class="op">)))</span><span class="pp">  </span><span class="co">// e.g., PA4 low</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#define DS1722_CS_HIGH</span><span class="op">()</span><span class="pp">  </span><span class="op">(</span><span class="pp">GPIOA</span><span class="op">-&gt;</span><span class="pp">BSRR </span><span class="op">=</span><span class="pp"> </span><span class="op">(</span><span class="dt">uint32_t</span><span class="op">)(</span><span class="dv">1</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span><span class="dv">4</span><span class="op">))</span><span class="pp">         </span><span class="co">// PA4 high</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">// === Function: SPI Transfer (single byte) ===</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint8_t</span> SPI_TransferByte<span class="op">(</span>SPI_TypeDef <span class="op">*</span>SPIx<span class="op">,</span> <span class="dt">uint8_t</span> data<span class="op">)</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!(</span>SPIx<span class="op">-&gt;</span>SR <span class="op">&amp;</span> SPI_SR_TXE<span class="op">));</span>     <span class="co">// Wait until TX buffer empty</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">*((</span>__IO <span class="dt">uint8_t</span> <span class="op">*)&amp;</span>SPIx<span class="op">-&gt;</span>DR<span class="op">)</span> <span class="op">=</span> data<span class="op">;</span>  <span class="co">// Write data to SPI data register</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!(</span>SPIx<span class="op">-&gt;</span>SR <span class="op">&amp;</span> SPI_SR_RXNE<span class="op">));</span>    <span class="co">// Wait until RX buffer not empty</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">*((</span>__IO <span class="dt">uint8_t</span> <span class="op">*)&amp;</span>SPIx<span class="op">-&gt;</span>DR<span class="op">);</span>  <span class="co">// Read received data</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co">// === Function: Read Temperature ===</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> DS1722_ReadTemperature<span class="op">(</span>SPI_TypeDef <span class="op">*</span>SPIx<span class="op">)</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> msb<span class="op">,</span> lsb<span class="op">;</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> raw<span class="op">;</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> temperature<span class="op">;</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    DS1722_CS_LOW<span class="op">();</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read MSB</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    SPI_TransferByte<span class="op">(</span>SPIx<span class="op">,</span> DS1722_REG_TEMP_MSB<span class="op">);</span>  <span class="co">// Send command</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    msb <span class="op">=</span> SPI_TransferByte<span class="op">(</span>SPIx<span class="op">,</span> <span class="bn">0x00</span><span class="op">);</span>           <span class="co">// Dummy write to read</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read LSB (optional for higher resolution)</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    SPI_TransferByte<span class="op">(</span>SPIx<span class="op">,</span> DS1722_REG_TEMP_LSB<span class="op">);</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    lsb <span class="op">=</span> SPI_TransferByte<span class="op">(</span>SPIx<span class="op">,</span> <span class="bn">0x00</span><span class="op">);</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    DS1722_CS_HIGH<span class="op">();</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Combine bytes (MSB: bits 15‚Äì8, LSB: bits 7‚Äì0)</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    raw <span class="op">=</span> <span class="op">((</span><span class="dt">uint16_t</span><span class="op">)</span>msb <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">|</span> lsb<span class="op">;</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Convert to ¬∞C</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// DS1722 uses 0.5¬∞C per bit in 9-bit mode, or 0.0625¬∞C/bit in 12-bit mode.</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Assume 12-bit mode by default.</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    temperature <span class="op">=</span> <span class="op">(</span>raw <span class="op">&gt;&gt;</span> <span class="dv">4</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.0625</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> temperature<span class="op">;</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
<section id="setup-notes" class="level3">
<h3 class="anchored" data-anchor-id="setup-notes">‚öôÔ∏è Setup Notes</h3>
<ol type="1">
<li><p><strong>SPI Configuration</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: SPI1 on STM32L432KC</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>RCC<span class="op">-&gt;</span>APB2ENR <span class="op">|=</span> RCC_APB2ENR_SPI1EN<span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>RCC<span class="op">-&gt;</span>AHB2ENR <span class="op">|=</span> RCC_AHB2ENR_GPIOAEN<span class="op">;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">// SPI1 pins: PA5=SCK, PA6=MISO, PA7=MOSI, PA4=CS</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>GPIOA<span class="op">-&gt;</span>MODER <span class="op">&amp;=</span> <span class="op">~(</span>GPIO_MODER_MODE4_Msk <span class="op">|</span> GPIO_MODER_MODE5_Msk <span class="op">|</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                  GPIO_MODER_MODE6_Msk <span class="op">|</span> GPIO_MODER_MODE7_Msk<span class="op">);</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>GPIOA<span class="op">-&gt;</span>MODER <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> GPIO_MODER_MODE5_Pos<span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="dv">1</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> GPIO_MODER_MODE6_Pos<span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="dv">1</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> GPIO_MODER_MODE7_Pos<span class="op">);</span> <span class="co">// AF mode</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>GPIOA<span class="op">-&gt;</span>AFR<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">|=</span> <span class="op">(</span><span class="dv">5</span> <span class="op">&lt;&lt;</span> <span class="op">(</span><span class="dv">5</span><span class="op">*</span><span class="dv">4</span><span class="op">))</span> <span class="op">|</span> <span class="op">(</span><span class="dv">5</span> <span class="op">&lt;&lt;</span> <span class="op">(</span><span class="dv">6</span><span class="op">*</span><span class="dv">4</span><span class="op">))</span> <span class="op">|</span> <span class="op">(</span><span class="dv">5</span> <span class="op">&lt;&lt;</span> <span class="op">(</span><span class="dv">7</span><span class="op">*</span><span class="dv">4</span><span class="op">));</span> <span class="co">// AF5 for SPI1</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>GPIOA<span class="op">-&gt;</span>MODER <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> GPIO_MODER_MODE4_Pos<span class="op">);</span> <span class="co">// CS as output</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>DS1722_CS_HIGH<span class="op">();</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>SPI1<span class="op">-&gt;</span>CR1 <span class="op">=</span> SPI_CR1_MSTR <span class="op">|</span> SPI_CR1_SSM <span class="op">|</span> SPI_CR1_SSI <span class="op">|</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>            SPI_CR1_CPOL <span class="op">|</span> SPI_CR1_CPHA <span class="op">|</span> SPI_CR1_BR_1<span class="op">;</span> <span class="co">// Mode 3, Master, SSM</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>SPI1<span class="op">-&gt;</span>CR1 <span class="op">|=</span> SPI_CR1_SPE<span class="op">;</span> <span class="co">// Enable SPI</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong>Call Example</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> temp <span class="op">=</span> DS1722_ReadTemperature<span class="op">(</span>SPI1<span class="op">);</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>printf<span class="op">(</span><span class="st">"Temperature: </span><span class="sc">%.2f</span><span class="st"> ¬∞C</span><span class="sc">\\</span><span class="st">n"</span><span class="op">,</span> temp<span class="op">);</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
</ol>
<hr>
</section>
<section id="optional-enhancements" class="level3">
<h3 class="anchored" data-anchor-id="optional-enhancements">üß© Optional Enhancements</h3>
<ul>
<li>Add error checking (e.g., SPI timeout).</li>
<li>Handle precision configuration (DS1722 allows setting resolution in config register <code>0x0A</code>).</li>
<li>Wrap SPI init and read in FreeRTOS-safe critical sections if multitasking.</li>
</ul>
<hr>
<p>Would you like me to extend this so it <strong>initializes the DS1722</strong> (sets continuous conversion and precision) before reading temperature? That would make it fully ready for embedded use.</p>
</section>
</section>
<section id="reflection" class="level2">
<h2 class="anchored" data-anchor-id="reflection">Reflection</h2>
<p>For the website presonally I think it is really clean. The colors are a good contrast between the blue and the whie and the Temperature reading is nice and big so it is easy to see for the user. They have for the led on and off they have a rendered led which is visually very helpful. The precision is converted from bits to decimal which is more understandable for users. It has a bunch of other little features like last time update and a debug log at the bottom making it easier to fix. However when I tried to render it on my ESP8266 through the MCU the site would not render because I couldn‚Äôt even build it. The direct copy and paste was not viable because the formatting into char was a little different from what chat gave me.</p>
<p>For the C code provided by Chat GPT it was overall pretty good. However it doesn‚Äôt utilize a lot of preexisting libraries that I have. For example doing all the GPIO pin enables it is doing direct bit manipulation making it a little difficult to understand. IT forgets to do a few specific things such as seting RXNE threshold to 8 bits and enabling SS output. It doesn‚Äôt set hte frame format to 8 bits. For the temperature reading its overal really solid. It doesn‚Äôt declare any of the variables as volatile which is annoying. The way it converts from binay to float is also a little concerning. It does it differntly by then shifting the combined number back which does make sense but it assumes 12 bit resolution. The code doesn‚Äôt compile because there is some sort of syntax error involving a paranthesis.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/kanparker\.github\.io\/e155-portfolio\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>