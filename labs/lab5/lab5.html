<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.21">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kanoa Parker">
<meta name="dcterms.date" content="2025-10-07">
<meta name="description" content="Programming a STM32L432KC Microcontroller to read pulses from a motor encoder and interpreting those waves as interupts in order to calculate rotation speed.">

<title>Lab 5 – E155 Portfolio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-ea1d7ac60288e0f1efdbc993fd8432ae.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e31584831b205ffbb2d98406f31c2a5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">E155 Portfolio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../labss.html"> 
<span class="menu-text">LABS</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resources.html"> 
<span class="menu-text">resources</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#table-of-contents" id="toc-table-of-contents" class="nav-link active" data-scroll-target="#table-of-contents">Table of Contents</a></li>
  <li><a href="#this-it-the-introduction" id="toc-this-it-the-introduction" class="nav-link" data-scroll-target="#this-it-the-introduction">This it the Introduction </a><a name="introdction" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#schematic" id="toc-schematic" class="nav-link" data-scroll-target="#schematic">Schematic </a><a name="Schematic" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#flow-chart" id="toc-flow-chart" class="nav-link" data-scroll-target="#flow-chart">Flow Chart </a><a name="flow_chart" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#c-code" id="toc-c-code" class="nav-link" data-scroll-target="#c-code">C Code </a><a name="c_code" class="nav-link" data-scroll-target="undefined"></a>
  <ul class="collapse">
  <li><a href="#main" id="toc-main" class="nav-link" data-scroll-target="#main">main </a><a name="main" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#exti0_irqhandler" id="toc-exti0_irqhandler" class="nav-link" data-scroll-target="#exti0_irqhandler">EXTI0_IRQHandler </a><a name="exti0" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#exti1_irqhandler" id="toc-exti1_irqhandler" class="nav-link" data-scroll-target="#exti1_irqhandler">EXTI1_IRQHandler </a><a name="exti1" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#interupt_setup" id="toc-interupt_setup" class="nav-link" data-scroll-target="#interupt_setup">interupt_setup</a><a name="int_setup" class="nav-link" data-scroll-target="undefined"></a></li>
  </ul></li>
  <li><a href="#calculationsverification" id="toc-calculationsverification" class="nav-link" data-scroll-target="#calculationsverification">Calculations/Verification </a><a name="calc" class="nav-link" data-scroll-target="undefined"></a>
  <ul class="collapse">
  <li><a href="#hand-calculations" id="toc-hand-calculations" class="nav-link" data-scroll-target="#hand-calculations">Hand Calculations</a></li>
  </ul></li>
  <li><a href="#comparison-of-manual-vs-interupts" id="toc-comparison-of-manual-vs-interupts" class="nav-link" data-scroll-target="#comparison-of-manual-vs-interupts">Comparison of Manual vs Interupts </a><a name="compare" class="nav-link" data-scroll-target="undefined"></a></li>
  <li><a href="#ai-prototype" id="toc-ai-prototype" class="nav-link" data-scroll-target="#ai-prototype">AI Prototype </a><a name="aip" class="nav-link" data-scroll-target="undefined"></a>
  <ul class="collapse">
  <li><a href="#understanding-the-hardware-options" id="toc-understanding-the-hardware-options" class="nav-link" data-scroll-target="#understanding-the-hardware-options">⚙️ 1. Understanding the Hardware Options</a>
  <ul class="collapse">
  <li><a href="#recommended-pins-for-exti-interrupts" id="toc-recommended-pins-for-exti-interrupts" class="nav-link" data-scroll-target="#recommended-pins-for-exti-interrupts">✅ Recommended pins for EXTI interrupts</a></li>
  </ul></li>
  <li><a href="#interrupt-based-quadrature-decoding-logic" id="toc-interrupt-based-quadrature-decoding-logic" class="nav-link" data-scroll-target="#interrupt-based-quadrature-decoding-logic">🧩 2. Interrupt-based Quadrature Decoding Logic</a>
  <ul class="collapse">
  <li><a href="#setup-outline" id="toc-setup-outline" class="nav-link" data-scroll-target="#setup-outline"><strong>Setup outline</strong></a></li>
  </ul></li>
  <li><a href="#example-code-interrupt-based-approach" id="toc-example-code-interrupt-based-approach" class="nav-link" data-scroll-target="#example-code-interrupt-based-approach">🧠 3. Example Code (Interrupt-based approach)</a></li>
  <li><a href="#alternative-better-hardware-encoder-mode" id="toc-alternative-better-hardware-encoder-mode" class="nav-link" data-scroll-target="#alternative-better-hardware-encoder-mode">⚡ 4. Alternative (Better) Hardware Encoder Mode</a></li>
  <li><a href="#recommendation" id="toc-recommendation" class="nav-link" data-scroll-target="#recommendation">✅ Recommendation</a></li>
  <li><a href="#reflection" id="toc-reflection" class="nav-link" data-scroll-target="#reflection">Reflection</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lab 5</h1>
</div>

<div>
  <div class="description">
    Programming a STM32L432KC Microcontroller to read pulses from a motor encoder and interpreting those waves as interupts in order to calculate rotation speed.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Kanoa Parker </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 7, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="table-of-contents" class="level1">
<h1>Table of Contents</h1>
<ol type="1">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#Schematic">Schematic</a></li>
<li><a href="#flow_chart">Flow Chart</a></li>
<li><a href="#c_code">C Code</a> 4.1 <a href="#main">main</a> 4.2 <a href="#exti0">EXTI0_IRQHandler</a> 4.3 <a href="#exti1">EXTI1_IRQHandler</a> 4.4 <a href="#int_setup">interupt_setup</a></li>
<li><a href="#calc">Calculations/Verification</a></li>
<li><a href="#compare">Comparison of Manual vs Interupts</a></li>
<li><a href="#aip">AI Prototype</a></li>
</ol>
</section>
<section id="this-it-the-introduction" class="level1">
<h1>This it the Introduction <a name="introdction"></a></h1>
<p>In this Lab I programmed a STM32L432KC Microcontroller to read the speed of a 25GA-370 DC Brusheless Motor. The microcontroller read the square wave produced by the motor’s encoder and turned those signals into interupts. Both the rising and falling edge of the pulse were counted as interupt signals. Using an interupt handler which determined whether the signal was a rising or falling edge the signal was recorded and the interupt flag reset. The lab meets all specificfication and took 8 hours total to complete.</p>
</section>
<section id="schematic" class="level1">
<h1>Schematic <a name="Schematic"></a></h1>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images\lab5_schematic.jpg" class="img-fluid figure-img"></p>
<figcaption>Schematic of Bread Board</figcaption>
</figure>
</div>
</section>
<section id="flow-chart" class="level1">
<h1>Flow Chart <a name="flow_chart"></a></h1>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images\flowchart.jpg" class="img-fluid figure-img"></p>
<figcaption>Flow Chart</figcaption>
</figure>
</div>
</section>
<section id="c-code" class="level1">
<h1>C Code <a name="c_code"></a></h1>
<p>This section contains code for the main module and interupt handlers and setup.</p>
<section id="main" class="level2">
<h2 class="anchored" data-anchor-id="main">main <a name="main"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    pinMode<span class="op">(</span>PA2<span class="op">,</span>GPIO_OUTPUT<span class="op">);</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Sequence Start</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="dt">volatile</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set system clock to 80 MHz</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//configureClock();</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">//configurePLL();</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//printf("Clock Configure\n");</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Enable button as input</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    gpioEnable<span class="op">(</span>GPIO_PORT_A<span class="op">);</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Gpio Enable</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    pinMode<span class="op">(</span>PA0<span class="op">,</span> GPIO_INPUT<span class="op">);</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    pinMode<span class="op">(</span>PA1<span class="op">,</span> GPIO_INPUT<span class="op">);</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    pinMode<span class="op">(</span>PA2<span class="op">,</span> GPIO_OUTPUT<span class="op">);</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Pinmode</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    GPIOA<span class="op">-&gt;</span>PUPDR <span class="op">|=</span> _VAL2FLD<span class="op">(</span>GPIO_PUPDR_PUPD0<span class="op">,</span> <span class="bn">0b10</span><span class="op">);</span> <span class="co">// Set PA0 as pull down</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    GPIOA<span class="op">-&gt;</span>PUPDR <span class="op">|=</span> _VAL2FLD<span class="op">(</span>GPIO_PUPDR_PUPD1<span class="op">,</span> <span class="bn">0b10</span><span class="op">);</span> <span class="co">// Set PA1 as pull down</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Pull Up and Down</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize timer</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    RCC<span class="op">-&gt;</span>APB1ENR1 <span class="op">|=</span> RCC_APB1ENR1_TIM2EN<span class="op">;</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    initTIM<span class="op">(</span>DELAY_TIM<span class="op">);</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Timer Initialize</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">//set up interupts</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    interupt_set<span class="op">();</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Interupt Set</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="dt">volatile</span> leadA<span class="op">;</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Volatile A Set</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="dt">volatile</span> leadB<span class="op">;</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Hit While Loop</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="dt">volatile</span> nn<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    digitalWrite<span class="op">(</span>PA2<span class="op">,</span>PIO_HIGH<span class="op">);</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(</span><span class="dv">1</span><span class="op">){</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">//interupt handler</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        EXTI0_IRQHandler<span class="op">();</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        EXTI1_IRQHandler<span class="op">();</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">//calculate speed</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">//write to serial if it has been a second</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>write_counter<span class="op">==</span><span class="dv">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>            speed <span class="op">=</span> <span class="op">(</span><span class="dt">float</span><span class="op">)(</span>A_count <span class="op">+</span> B_count<span class="op">)/(</span><span class="fl">816.0</span><span class="op">*</span><span class="dv">2</span><span class="op">);</span> </span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"Current Speed is </span><span class="sc">%f</span><span class="st"> REV/s</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> speed<span class="op">);</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>            write_counter <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"Acount </span><span class="sc">%d</span><span class="st"> Bcount </span><span class="sc">%d</span><span class="st"> </span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> A_count<span class="op">,</span> B_count<span class="op">);</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>            A_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>            B_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"</span><span class="sc">%d</span><span class="st"> </span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> nn<span class="op">);</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>            nn <span class="op">=</span> nn<span class="op">+</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">//delay and increment counter</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        delay_millis<span class="op">(</span>TIM2<span class="op">,</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        write_counter <span class="op">=</span> <span class="op">(</span>write_counter <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">//printf("%d \n", write_counter);</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>        togglePin<span class="op">(</span>PA2<span class="op">);</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Main Module.<br>
Link to github with full list of library and header files. <a href="https://github.com/kanparker/e155_lab5">Link to Git Hub</a>.</p>
</section>
<section id="exti0_irqhandler" class="level2">
<h2 class="anchored" data-anchor-id="exti0_irqhandler">EXTI0_IRQHandler <a name="exti0"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> EXTI1_IRQHandler<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//read the leads</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> leadA <span class="op">=</span> digitalRead<span class="op">(</span>PA0<span class="op">);</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> leadB <span class="op">=</span> digitalRead<span class="op">(</span>PA1<span class="op">);</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check that the button was what triggered our interrupt</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>EXTI<span class="op">-&gt;</span>PR1 <span class="op">&amp;</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> gpioPinOffset<span class="op">(</span>PA1<span class="op">))){</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// If so, clear the interrupt (NB: Write 1 to reset.)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        EXTI<span class="op">-&gt;</span>PR1 <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> gpioPinOffset<span class="op">(</span>PA1<span class="op">));</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Rising Edge</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>leadB <span class="op">==</span> <span class="dv">1</span><span class="op">){</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>            <span class="co">//check direction</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>leadA <span class="op">==</span><span class="dv">1</span><span class="op">){</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                B_count <span class="op">=</span> B_count <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span><span class="op">{</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                B_count <span class="op">=</span> B_count <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Falling Edge</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span><span class="op">{</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>leadA <span class="op">==</span><span class="dv">0</span><span class="op">){</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                B_count <span class="op">=</span> B_count <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span><span class="op">{</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                B_count <span class="op">=</span> B_count <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Interupt handler for EXTI0 which is connected to the encoder signal A.</p>
</section>
<section id="exti1_irqhandler" class="level2">
<h2 class="anchored" data-anchor-id="exti1_irqhandler">EXTI1_IRQHandler <a name="exti1"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> EXTI0_IRQHandler<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check that the button was what triggered our interrupt</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> leadA <span class="op">=</span> digitalRead<span class="op">(</span>PA0<span class="op">);</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> leadB <span class="op">=</span> digitalRead<span class="op">(</span>PA1<span class="op">);</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>EXTI<span class="op">-&gt;</span>PR1 <span class="op">&amp;</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> gpioPinOffset<span class="op">(</span>PA0<span class="op">))){</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// If so, clear the interrupt (NB: Write 1 to reset.)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        EXTI<span class="op">-&gt;</span>PR1 <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> gpioPinOffset<span class="op">(</span>PA0<span class="op">));</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Rising Edge</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>leadA <span class="op">==</span> <span class="dv">1</span><span class="op">){</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>            <span class="co">//check direction</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>leadB <span class="op">==</span><span class="dv">0</span><span class="op">){</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>                A_count <span class="op">=</span> A_count <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span><span class="op">{</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                A_count <span class="op">=</span> A_count <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Falling Edge</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span><span class="op">{</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>leadB <span class="op">==</span><span class="dv">0</span><span class="op">){</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                A_count <span class="op">=</span> A_count <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span><span class="op">{</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>                A_count <span class="op">=</span> A_count <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Interupt handler for EXTI0 which is connected to the encoder signal A.</p>
</section>
<section id="interupt_setup" class="level2">
<h2 class="anchored" data-anchor-id="interupt_setup">interupt_setup<a name="int_setup"></a></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> interupt_set<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. Enable SYSCFG clock domain in RCC</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    RCC<span class="op">-&gt;</span>APB2ENR <span class="op">|=</span> RCC_APB2ENR_SYSCFGEN<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. Configure EXTICR for the input button interrupt</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    SYSCFG<span class="op">-&gt;</span>EXTICR<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">|=</span> _VAL2FLD<span class="op">(</span>SYSCFG_EXTICR1_EXTI0<span class="op">,</span> <span class="bn">0b000</span><span class="op">);</span> <span class="co">// Select PA0</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    SYSCFG<span class="op">-&gt;</span>EXTICR<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">|=</span> _VAL2FLD<span class="op">(</span>SYSCFG_EXTICR1_EXTI1<span class="op">,</span> <span class="bn">0b000</span><span class="op">);</span> <span class="co">// Select PA1</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Configure interrupt for falling and rising edge of GPIO pin for button</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. Configure mask bit</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    EXTI<span class="op">-&gt;</span>IMR1 <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> gpioPinOffset<span class="op">(</span>PA0<span class="op">));</span> <span class="co">// Configure the mask bit</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    EXTI<span class="op">-&gt;</span>IMR1 <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> gpioPinOffset<span class="op">(</span>PA1<span class="op">));</span> <span class="co">// Configure the mask bit</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. Enable rising edge trigger</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    EXTI<span class="op">-&gt;</span>RTSR1 <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> gpioPinOffset<span class="op">(</span>PA0<span class="op">));</span><span class="co">// Disable rising edge trigger</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    EXTI<span class="op">-&gt;</span>RTSR1 <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> gpioPinOffset<span class="op">(</span>PA1<span class="op">));</span><span class="co">// Disable rising edge trigger</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 3. Enable falling edge trigger</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    EXTI<span class="op">-&gt;</span>FTSR1 <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> gpioPinOffset<span class="op">(</span>PA0<span class="op">));</span><span class="co">// Enable falling edge trigger</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    EXTI<span class="op">-&gt;</span>FTSR1 <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> gpioPinOffset<span class="op">(</span>PA1<span class="op">));</span><span class="co">// Enable falling edge trigger</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 4. Turn on EXTI interrupt in NVIC_ISER</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    NVIC<span class="op">-&gt;</span>ISER<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> EXTI0_IRQn<span class="op">);</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    NVIC<span class="op">-&gt;</span>ISER<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">|=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> EXTI1_IRQn<span class="op">);</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Enable interrupts globally</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    __enable_irq<span class="op">();</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Interupt setup and handle.</p>
</section>
</section>
<section id="calculationsverification" class="level1">
<h1>Calculations/Verification <a name="calc"></a></h1>
<section id="hand-calculations" class="level2">
<h2 class="anchored" data-anchor-id="hand-calculations">Hand Calculations</h2>
<p><img src="images\handcalculations.jpg" class="img-fluid" alt="Hand Calculations"> ## Micro ControllerResults <img src="images\measure_results.jpg" class="img-fluid" alt="Measured Results"></p>
<p>Results from the micro controller ## Measured Results Oscilliscope <img src="images\oscovalue.png" class="img-fluid" alt="Measured Results"> The measured encoding signal should have a frequency equal to half of the measured pulses.</p>
</section>
</section>
<section id="comparison-of-manual-vs-interupts" class="level1">
<h1>Comparison of Manual vs Interupts <a name="compare"></a></h1>
<p>Comparing Manual vs Interupt implementation. <img src="images\goodsignal.jpg" class="img-fluid" alt="Minimum Sampling"> The maximum frequency of the encoded motor signal is 2kHz. Inorder to record that signal we need to run a sampling frequency of at least 4 kHz. This is because in order to detect a rising or falling edge we need to record both the low and high state to recognize an edge. <img src="images\badsignal.jpg" class="img-fluid" alt="Slipping Signal"> The maximum sampling frequency that we can have with a 1ms delay is 1kHz. So the maximum signal that we can record is a 500 Hz wave. In addition during the interupt state we are not reading the encoder signal. The maximum speed that we can recognize is 1 Hz. However using interupts that is even based we are always polling the signal. The only time we are not polling the system is when we jump to the interupt handler. The time to jump from the main code to the interupt handler, execute the interupt handler and jump back is on the order of tens of micro seconds. So the interupt system can handle signals on the order of tens vs hundreds of kilo hz.</p>
</section>
<section id="ai-prototype" class="level1">
<h1>AI Prototype <a name="aip"></a></h1>
<p>Great — using interrupts to interface with a quadrature encoder on an <strong>STM32L432KC</strong> is a solid choice, since it gives you good timing accuracy without heavy CPU usage.</p>
<p>Let’s go step by step:</p>
<hr>
<section id="understanding-the-hardware-options" class="level2">
<h2 class="anchored" data-anchor-id="understanding-the-hardware-options">⚙️ 1. Understanding the Hardware Options</h2>
<p>The <strong>STM32L432KC (Nucleo-L432KC)</strong> has several timers that support <strong>quadrature encoder interface mode</strong> natively — that’s <strong>TIM1, TIM2, TIM3, and TIM4</strong>.</p>
<p>However, if you specifically want to <strong>handle the encoder using interrupts on GPIO pins</strong> (instead of using the built-in timer decoder), you can connect the two encoder signals (usually called <strong>Channel A</strong> and <strong>Channel B</strong>) to <strong>any GPIO pins that support EXTI interrupts</strong>.</p>
<section id="recommended-pins-for-exti-interrupts" class="level3">
<h3 class="anchored" data-anchor-id="recommended-pins-for-exti-interrupts">✅ Recommended pins for EXTI interrupts</h3>
<p>All GPIO pins on STM32L4 can trigger EXTI interrupts, <strong>but only one pin per EXTI line</strong> (0–15). So you can, for example, use:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Encoder Signal</th>
<th>STM32 Pin</th>
<th>EXTI Line</th>
<th>Example GPIO</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Channel A</td>
<td>PA0</td>
<td>EXTI0</td>
<td>D2 on Nucleo</td>
</tr>
<tr class="even">
<td>Channel B</td>
<td>PA1</td>
<td>EXTI1</td>
<td>D3 on Nucleo</td>
</tr>
</tbody>
</table>
<p>This lets you attach both to independent EXTI lines for simple handling.</p>
<p>If you prefer to <strong>use hardware encoder mode</strong> (recommended for efficiency), connect:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Encoder Signal</th>
<th>Timer</th>
<th>Alternate Function</th>
<th>Pins</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Channel A</td>
<td>TIM2_CH1</td>
<td>AF1</td>
<td>PA0</td>
</tr>
<tr class="even">
<td>Channel B</td>
<td>TIM2_CH2</td>
<td>AF1</td>
<td>PA1</td>
</tr>
</tbody>
</table>
<p>That way, TIM2 can automatically count encoder pulses without any manual interrupt logic.</p>
<hr>
</section>
</section>
<section id="interrupt-based-quadrature-decoding-logic" class="level2">
<h2 class="anchored" data-anchor-id="interrupt-based-quadrature-decoding-logic">🧩 2. Interrupt-based Quadrature Decoding Logic</h2>
<p>If you choose to decode in software using EXTI interrupts, here’s a simple example.</p>
<section id="setup-outline" class="level3">
<h3 class="anchored" data-anchor-id="setup-outline"><strong>Setup outline</strong></h3>
<ul>
<li>Connect encoder Channel A → PA0 (EXTI0)</li>
<li>Connect encoder Channel B → PA1 (EXTI1)</li>
<li>Enable rising/falling edge detection on both</li>
<li>Use interrupt handlers to update a position counter</li>
</ul>
<hr>
</section>
</section>
<section id="example-code-interrupt-based-approach" class="level2">
<h2 class="anchored" data-anchor-id="example-code-interrupt-based-approach">🧠 3. Example Code (Interrupt-based approach)</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"stm32l4xx_hal.h"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="dt">volatile</span> <span class="dt">int32_t</span> encoder_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Encoder pin definitions</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ENC_A_Pin GPIO_PIN_0</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ENC_A_Port GPIOA</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ENC_B_Pin GPIO_PIN_1</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ENC_B_Port GPIOA</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Encoder_Init<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    __HAL_RCC_GPIOA_CLK_ENABLE<span class="op">();</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    __HAL_RCC_SYSCFG_CLK_ENABLE<span class="op">();</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    GPIO_InitTypeDef GPIO_InitStruct <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Configure Channel A and B as inputs with pullups</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    GPIO_InitStruct<span class="op">.</span>Pin <span class="op">=</span> ENC_A_Pin <span class="op">|</span> ENC_B_Pin<span class="op">;</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    GPIO_InitStruct<span class="op">.</span>Mode <span class="op">=</span> GPIO_MODE_IT_RISING_FALLING<span class="op">;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    GPIO_InitStruct<span class="op">.</span>Pull <span class="op">=</span> GPIO_PULLUP<span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    HAL_GPIO_Init<span class="op">(</span>GPIOA<span class="op">,</span> <span class="op">&amp;</span>GPIO_InitStruct<span class="op">);</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Enable interrupts for EXTI0 and EXTI1</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    HAL_NVIC_SetPriority<span class="op">(</span>EXTI0_IRQn<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    HAL_NVIC_EnableIRQ<span class="op">(</span>EXTI0_IRQn<span class="op">);</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    HAL_NVIC_SetPriority<span class="op">(</span>EXTI1_IRQn<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    HAL_NVIC_EnableIRQ<span class="op">(</span>EXTI1_IRQn<span class="op">);</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">int</span> Read_B<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> HAL_GPIO_ReadPin<span class="op">(</span>ENC_B_Port<span class="op">,</span> ENC_B_Pin<span class="op">);</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">int</span> Read_A<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> HAL_GPIO_ReadPin<span class="op">(</span>ENC_A_Port<span class="op">,</span> ENC_A_Pin<span class="op">);</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> HAL_GPIO_EXTI_Callback<span class="op">(</span><span class="dt">uint16_t</span> GPIO_Pin<span class="op">)</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read both signals to determine direction</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>GPIO_Pin <span class="op">==</span> ENC_A_Pin <span class="op">||</span> GPIO_Pin <span class="op">==</span> ENC_B_Pin<span class="op">)</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> A <span class="op">=</span> Read_A<span class="op">();</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> B <span class="op">=</span> Read_B<span class="op">();</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>A <span class="op">==</span> B<span class="op">)</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>            encoder_count<span class="op">++;</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>            encoder_count<span class="op">--;</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> EXTI0_IRQHandler<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    HAL_GPIO_EXTI_IRQHandler<span class="op">(</span>ENC_A_Pin<span class="op">);</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> EXTI1_IRQHandler<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    HAL_GPIO_EXTI_IRQHandler<span class="op">(</span>ENC_B_Pin<span class="op">);</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This gives you:</p>
<ul>
<li>A software-decoded quadrature count.</li>
<li>Rising/falling edge triggers for both A and B.</li>
<li>Minimal logic inside interrupts.</li>
</ul>
<hr>
</section>
<section id="alternative-better-hardware-encoder-mode" class="level2">
<h2 class="anchored" data-anchor-id="alternative-better-hardware-encoder-mode">⚡ 4. Alternative (Better) Hardware Encoder Mode</h2>
<p>If you want <em>no CPU overhead</em>, use <strong>TIM2 in encoder mode</strong>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>TIM_HandleTypeDef htim2<span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Encoder_TIM_Init<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    __HAL_RCC_TIM2_CLK_ENABLE<span class="op">();</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    __HAL_RCC_GPIOA_CLK_ENABLE<span class="op">();</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    GPIO_InitTypeDef GPIO_InitStruct <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    GPIO_InitStruct<span class="op">.</span>Pin <span class="op">=</span> GPIO_PIN_0 <span class="op">|</span> GPIO_PIN_1<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    GPIO_InitStruct<span class="op">.</span>Mode <span class="op">=</span> GPIO_MODE_AF_PP<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    GPIO_InitStruct<span class="op">.</span>Pull <span class="op">=</span> GPIO_PULLUP<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    GPIO_InitStruct<span class="op">.</span>Speed <span class="op">=</span> GPIO_SPEED_FREQ_LOW<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    GPIO_InitStruct<span class="op">.</span>Alternate <span class="op">=</span> GPIO_AF1_TIM2<span class="op">;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    HAL_GPIO_Init<span class="op">(</span>GPIOA<span class="op">,</span> <span class="op">&amp;</span>GPIO_InitStruct<span class="op">);</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    htim2<span class="op">.</span>Instance <span class="op">=</span> TIM2<span class="op">;</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    htim2<span class="op">.</span>Init<span class="op">.</span>Prescaler <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    htim2<span class="op">.</span>Init<span class="op">.</span>CounterMode <span class="op">=</span> TIM_COUNTERMODE_UP<span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    htim2<span class="op">.</span>Init<span class="op">.</span>Period <span class="op">=</span> <span class="bn">0xFFFF</span><span class="op">;</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    htim2<span class="op">.</span>Init<span class="op">.</span>ClockDivision <span class="op">=</span> TIM_CLOCKDIVISION_DIV1<span class="op">;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    TIM_Encoder_InitTypeDef sEncoderConfig <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    sEncoderConfig<span class="op">.</span>EncoderMode <span class="op">=</span> TIM_ENCODERMODE_TI12<span class="op">;</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    sEncoderConfig<span class="op">.</span>IC1Polarity <span class="op">=</span> TIM_INPUTCHANNELPOLARITY_RISING<span class="op">;</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    sEncoderConfig<span class="op">.</span>IC1Selection <span class="op">=</span> TIM_ICSELECTION_DIRECTTI<span class="op">;</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    sEncoderConfig<span class="op">.</span>IC2Polarity <span class="op">=</span> TIM_INPUTCHANNELPOLARITY_RISING<span class="op">;</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    sEncoderConfig<span class="op">.</span>IC2Selection <span class="op">=</span> TIM_ICSELECTION_DIRECTTI<span class="op">;</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    HAL_TIM_Encoder_Init<span class="op">(&amp;</span>htim2<span class="op">,</span> <span class="op">&amp;</span>sEncoderConfig<span class="op">);</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    HAL_TIM_Encoder_Start<span class="op">(&amp;</span>htim2<span class="op">,</span> TIM_CHANNEL_ALL<span class="op">);</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then, your current position is simply:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int32_t</span> position <span class="op">=</span> __HAL_TIM_GET_COUNTER<span class="op">(&amp;</span>htim2<span class="op">);</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
<section id="recommendation" class="level2">
<h2 class="anchored" data-anchor-id="recommendation">✅ Recommendation</h2>
<p>If your goal is <strong>precision and low CPU load</strong>, use <strong>TIM2 in hardware encoder mode</strong> on <strong>PA0/PA1</strong>. If you’re learning how encoders work or want a simple interrupt-driven method, use <strong>EXTI on PA0/PA1</strong> as shown above.</p>
<hr>
<p>Would you like me to provide the <strong>CubeMX configuration steps</strong> (and the generated HAL init code) for the TIM2 hardware encoder setup too? It makes it much easier to integrate into your project.</p>
</section>
<section id="reflection" class="level2">
<h2 class="anchored" data-anchor-id="reflection">Reflection</h2>
<p>Chatgpt recommended the same pins as mine for different reasons. It wanted to use the alternative function on PINs A0 and A1 using the encoder to automatically count the number of pulses. The first interupt based approach is fine however it does forget to mention to set what type of alternative function for pins A0 and A1. The code is very hard to read in addition the interupt handler calls on another function which I don’t know where it is defined. It sets prioties which I left as default.</p>
<p>The second recomendation it gives use the pins alternative functions as encoders and seems a little overkill.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/kanparker\.github\.io\/e155-portfolio\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>